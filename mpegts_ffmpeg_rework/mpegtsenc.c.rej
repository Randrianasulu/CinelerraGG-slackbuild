--- libavformat/mpegtsenc.c	2020-06-15 12:54:24.000000000 -0600
+++ libavformat/mpegtsenc.c	2020-10-15 12:16:07.300442476 -0600
@@ -79,8 +79,10 @@
     int64_t sdt_period; /* SDT period in PCR time base */
     int64_t pat_period; /* PAT/PMT period in PCR time base */
     int nb_services;
-    int64_t first_pcr;
-    int64_t next_pcr;
+    int64_t pcr_pos, pcr;
+    int64_t first_pcr, next_pcr;
+    int64_t delay;
+    int pcr_stream_pid;
     int mux_rate; ///< set to 1 when VBR
     int pes_payload_size;
 
@@ -804,16 +806,16 @@
 
 static int64_t get_pcr(const MpegTSWrite *ts, AVIOContext *pb)
 {
-    return av_rescale(avio_tell(pb) + 11, 8 * PCR_TIME_BASE, ts->mux_rate) +
-           ts->first_pcr;
+    int64_t pos = avio_tell(pb) + 11;
+    return ts->pcr + (ts->mux_rate == 1 ? (pos - ts->pcr_pos) * 8 :
+        av_rescale(pos - ts->pcr_pos, 8 * PCR_TIME_BASE, ts->mux_rate));
 }
 
 static void write_packet(AVFormatContext *s, const uint8_t *packet)
 {
     MpegTSWrite *ts = s->priv_data;
     if (ts->m2ts_mode) {
-        int64_t pcr = get_pcr(s->priv_data, s->pb);
-        uint32_t tp_extra_header = pcr % 0x3fffffff;
+        uint32_t tp_extra_header = get_pcr(ts, s->pb) % 0x3fffffff;
         tp_extra_header = AV_RB32(&tp_extra_header);
         avio_write(s->pb, (unsigned char *) &tp_extra_header,
                    sizeof(tp_extra_header));
@@ -1189,25 +1198,29 @@
 static void mpegts_insert_pcr_only(AVFormatContext *s, AVStream *st)
 {
     MpegTSWrite *ts = s->priv_data;
-    MpegTSWriteStream *ts_st = st->priv_data;
+    int64_t pcr = get_pcr(ts, s->pb);
+    MpegTSWriteStream *ts_st = st ? st->priv_data : 0;
+    uint32_t pcr_pid = ts_st ? ts_st->pid : ts->pcr_stream_pid;
     uint8_t *q;
     uint8_t buf[TS_PACKET_SIZE];
 
     q    = buf;
     *q++ = 0x47;
-    *q++ = ts_st->pid >> 8;
-    *q++ = ts_st->pid;
-    *q++ = 0x20 | ts_st->cc;   /* Adaptation only */
+    *q++ = pcr_pid >> 8;
+    *q++ = pcr_pid;
+    uint32_t flags =  0x20;    /* Adaptation only */
     /* Continuity Count field does not increment (see 13818-1 section 2.4.3.3) */
+    if(ts_st) flags |= ts_st->cc;
+    *q++ = flags;
     *q++ = TS_PACKET_SIZE - 5; /* Adaptation Field Length */
     *q++ = 0x10;               /* Adaptation flags: PCR present */
-    if (ts_st->discontinuity) {
+    if (ts_st && ts_st->discontinuity) {
         q[-1] |= 0x80;
         ts_st->discontinuity = 0;
     }
 
     /* PCR coded into 6 bytes */
-    q += write_pcr_bits(q, get_pcr(ts, s->pb));
+    q += write_pcr_bits(q, pcr);
 
     /* stuffing bytes */
     memset(q, 0xFF, TS_PACKET_SIZE - (q - buf));
@@ -1292,20 +1305,19 @@
 
     is_start = 1;
     while (payload_size > 0) {
-        int64_t pcr = AV_NOPTS_VALUE;
-        if (ts->mux_rate > 1)
-            pcr = get_pcr(ts, s->pb);
-        else if (dts != AV_NOPTS_VALUE)
-            pcr = (dts - delay) * 300;
-
-        retransmit_si_info(s, force_pat, force_sdt, pcr);
-        force_pat = 0;
-        force_sdt = 0;
+        // add 11, pcr references the last byte of program clock reference base
+        ts->pcr_pos = avio_tell(s->pb) + 11;
+        pcr = ts->pcr = ts->mux_rate != 1 ?
+            av_rescale(ts->pcr_pos, 8 * PCR_TIME_BASE, ts->mux_rate) :
+            (dts == AV_NOPTS_VALUE ? 0 : (dts - ts->delay) * 300);
+        if (force_pat || force_sdt) {
+            retransmit_si_info(s, force_pat, force_sdt);
+            force_pat = force_sdt = 0;
+        }
 
         write_pcr = 0;
         if (ts->mux_rate > 1) {
             /* Send PCR packets for all PCR streams if needed */
-            pcr = get_pcr(ts, s->pb);
             if (pcr >= ts->next_pcr) {
                 int64_t next_pcr = INT64_MAX;
                 for (int i = 0; i < s->nb_streams; i++) {
@@ -1315,36 +1327,43 @@
                     AVStream *st2 = s->streams[st2_index];
                     MpegTSWriteStream *ts_st2 = st2->priv_data;
                     if (ts_st2->pcr_period) {
-                        if (pcr - ts_st2->last_pcr >= ts_st2->pcr_period) {
-                            ts_st2->last_pcr = FFMAX(pcr - ts_st2->pcr_period, ts_st2->last_pcr + ts_st2->pcr_period);
+                        if (pcr >= ts_st2->pcr_timer) {
+                            ts_st2->pcr_timer = pcr + ts_st2->pcr_period;
                             if (st2 != st) {
                                 mpegts_insert_pcr_only(s, st2);
-                                pcr = get_pcr(ts, s->pb);
                             } else {
                                 write_pcr = 1;
                             }
                         }
-                        next_pcr = FFMIN(next_pcr, ts_st2->last_pcr + ts_st2->pcr_period);
+                        next_pcr = FFMIN(next_pcr, ts_st2->pcr_timer);
                     }
                 }
                 ts->next_pcr = next_pcr;
             }
-            if (dts != AV_NOPTS_VALUE && (dts - pcr / 300) > delay) {
-                /* pcr insert gets priority over null packet insert */
-                if (write_pcr)
-                    mpegts_insert_pcr_only(s, st);
-                else
-                    mpegts_insert_null_packet(s);
-                /* recalculate write_pcr and possibly retransmit si_info */
-                continue;
-            }
-        } else if (ts_st->pcr_period && pcr != AV_NOPTS_VALUE) {
-            if (pcr - ts_st->last_pcr >= ts_st->pcr_period && is_start) {
-                ts_st->last_pcr = FFMAX(pcr - ts_st->pcr_period, ts_st->last_pcr + ts_st->pcr_period);
+        }
+        else if (ts_st->pcr_period) {
+            if (pcr >= ts_st->pcr_timer) {
+                ts_st->pcr_timer = pcr + ts_st->pcr_period;
                 write_pcr = 1;
             }
         }
 
+        if (write_pcr && ts->pcr_stream_pid >= 0) {
+           mpegts_insert_pcr_only(s, 0);
+           continue;
+        }
+
+        if (ts->mux_rate > 1 && dts != AV_NOPTS_VALUE &&
+               (dts - pcr / 300) > ts->delay) {
+           /* pcr insert gets priority over null packet insert */
+           if (write_pcr)
+               mpegts_insert_pcr_only(s, st);
+            else
+               mpegts_insert_null_packet(s);
+            /* recalculate write_pcr and possibly retransimit si_info */
+            continue;
+        }
+
         /* prepare packet header */
         q    = buf;
         *q++ = 0x47;
